<!DOCTYPE html>
<html lang='en-US'>
<head>
	<title>Budgie</title>
	<meta charset="UTF-8">
	<link rel='stylesheet' type='text/css' href='Main.css'>
	<link href='https://fonts.googleapis.com/css?family=Comfortaa' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Sintony' rel='stylesheet'>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
	<div class='logo'>
		<h1>Budgie</h1>
	</div>

	<div id = 'enter_info'>
		<h2>Let's get started <var class='user_name'></var></h2>
		<input id = 'new_user_salary' type="text" placeholder = "Enter your yearly salary" required>
		<select id='selectstate' name = 'location' required>
			<option value = 'Select your state'>Select your state</option>
			<option value = 'AL'>AL</option>
			<option value = 'AK'>AK</option>
			<option value = 'AZ'>AZ</option>
			<option value = 'AR'>AR</option>
			<option value = 'CA'>CA</option>
			<option value = 'CO'>CO</option>
			<option value = 'CT'>CT</option>
			<option value = 'DE'>DE</option>
			<option value = 'FL'>FL</option>
			<option value = 'GA'>GA</option>
			<option value = 'HI'>HI</option>
			<option value = 'ID'>ID</option>
			<option value = 'IL'>IL</option>
			<option value = 'IN'>IN</option>
			<option value = 'IA'>IA</option>
			<option value = 'KS'>KS</option>
			<option value = 'KY'>KY</option>
			<option value = 'LA'>LA</option>
			<option value = 'ME'>ME</option>
			<option value = 'MD'>MD</option>
			<option value = 'MA'>MA</option>
			<option value = 'MI'>MI</option>
			<option value = 'MN'>MN</option>
			<option value = 'MS'>MS</option>
			<option value = 'MO'>MO</option>
			<option value = 'MT'>MT</option>
			<option value = 'NE'>NE</option>
			<option value = 'NV'>NV</option>
			<option value = 'NH'>NH</option>
			<option value = 'NJ'>NJ</option>
			<option value = 'NM'>NM</option>
			<option value = 'NY'>NY</option>
			<option value = 'NC'>NC</option>
			<option value = 'ND'>ND</option>
			<option value = 'OH'>OH</option>
			<option value = 'OK'>OK</option>
			<option value = 'OR'>OR</option>
			<option value = 'PA'>PA</option>
			<option value = 'RI'>RI</option>
			<option value = 'SC'>SC</option>
			<option value = 'SD'>SD</option>
			<option value = 'TN'>TN</option>
			<option value = 'TX'>TX</option>
			<option value = 'UT'>UT</option>
			<option value = 'VT'>VT</option>
			<option value = 'VA'>VA</option>
			<option value = 'WA'>WA</option>
			<option value = 'WV'>WV</option>
			<option value = 'WI'>WI</option>
			<option value = 'WY'>WY</option>
		</select>
		<button id = 'start_budget_button' onclick = 'new_user()'>Start budgeting</button>
		<div id='snackbar-new'></div>
	</div>
	<div id = 'main'>
		<div id = 'line'></div>
		<button id = 'logout' onclick = 'logout_user()'>Log Out</button>
		<h2 id = 'welcome_user'>Welcome <var class = 'user_name'></var>!</h2>
		<div id = 'user_box'>
			<p>Current State:<br />
			<var class='user_state'></var></p><!--Change to a location variable from database-->
			<br>
			<p>Current Salary:<br>
				<var class = 'user_salary'></var></p>
			<br>
			<p>After Tax Salary:<br>
				<var class = 'ats'></var>
			</p>
			<!--<button id='edit_user_info' onclick = 'edit_user_info()'>Edit</button>-->
			<!--<button id='save_user_info' onclick = 'save_user_info()'>Save</button>-->
		</div>
		<div class = 'form'>
			<div class = "options">
					<button class = "tablink" onclick = "openOption('Y', this, '#112C5F')" id = "defaultOpen">Yearly</button>
					<button class = "tablink" onclick = "openOption('M', this, '#112C5F')">Monthly</button>
					<button class = "tablink" onclick = "openOption('B', this, '#112C5F')">Biweekly</button>
			</div>
			<table id='spending_table'>
				<tr id = 'headers'>
				    <th>Expense</th>
				    <th>%</th>
				    <th>$</th>
				 </tr>
				<tr id = 'add_row'>
					<td><input id = 'new_expense' type="text" placeholder = "Enter a new expense"></td>
					<td><input id = 'new_percent' type="text" placeholder = "% of budget"></td>
					<td><button id = 'enter_new_expense' type = 'submit' onclick = 'enter_new_expense()'>Enter</button></td>
				</tr>
				<tfoot id = 'total'>
	   				<tr>
					    <th>Total :</th>
					    <th id = 'total_percent'>100</th>
					    <th id = 'total_salary'><var class = 'ats'></var></th>
					</tr>
				</tfoot>
			</table>
		</div>
		<button id = 'edit_table' onclick = 'edit_table_func()'><img src="https://image.flaticon.com/icons/png/512/52/52951.png" width='50px' height="50px"></button>
		<button id = 'save_table' onclick = 'save_table_func()'><img src="https://png.icons8.com/?id=11695&size=280" width='50px' height="50px"></button>
		<div id='snackbar-main'></div>
	</div>
	<script>
		var x = localStorage.getItem('gate');
		var y = document.getElementById('enter_info');
		var main = document.getElementById('main');

		var url_base = "https://wwwp.cs.unc.edu/Courses/comp426-f17/users/marinzam/Budgie/";


		var user_name = 'Sam'; /*replace with user first name*/
		var user_location = 'Indiana';
		var yearly_salary = 70000;/*replace with user yearly salary*/
		var after_tax_salary = 50000;/*replace with user ats */

		refresh_user_box();

		//var save_user = document.getElementById('save_user_info');
		var save_table = document.getElementById('save_table');
		var table = document.getElementById('spending_table');
		var tperc = document.getElementById('total_percent');

		var tmp = [];

    	/*initially hide save table button and save user button*/
    	save_table.style.display = 'none';
		//save_user.style.display = 'none';

		/*if it is a new user, prompt them to enter in information*/
		if (x==='SignUp'){
			console.log("what is the received name");
			console.log(localStorage.getItem('first_name'));
			user_name = localStorage.getItem('first_name');
			y.style.display = 'block';
			main.style.display = 'none';
			
			refresh_user_box();

			// var new_us = document.getElementById('new_user_salary').value;
			// var new_ul = document.getElementById('selectstate').value;
			/* CreateBudget.php */
			// $.ajax(url_base + "/CreateBudget.php",
	        //     {type: "POST",
	        //     dataType: "json",
	        //     data: JSON.stringify({
	        //         StateID: $("#selectstate").val(),
	        //         Salary: $("#new_user_salary").val()
	        //     }),
	        //     success: function(budget) {
	        //         console.log(budget);
			// 		user_name = budget['name'];
			// 		user_location = budget['state'];
			// 		yearly_salary = budget['salary'];
			// 		after_tax_salary = budget['afterTaxSalary'];
	        //         // populate table
	        //         for(var i=0; i<budget.split.length; i++){
	        //             var e = budget.split[i].name;
	        //             var p = budget.split[i].percentage;
	        //             enter_into_table(e,p);
	        //         }
			// 		refresh_user_box();
	        //     },
	        //     error: function(response) {
	        //         console.log(response);
	        //     }
	        // }); // create budget
		}
		else{
			y.style.display = 'none';
			main.style.display = 'block';

			/* GetBudget.php */
			$.ajax(url_base + "/GetBudget.php",
				{type: "POST",
				dataType: "json",
				success: function(budget) {
					console.log("success");
					console.log(budget);
					user_name = budget['name'];
					user_location = budget['state'];
					yearly_salary = budget['salary'];
					after_tax_salary = budget['afterTaxSalary'];
					// populate table
					for(var i=0; i<budget.split.length; i++){
						var e = budget.split[i].name;
						var p = budget.split[i].percentage;
						enter_into_table(e,p);
					}
					refresh_user_box();
				},
				error: function(response) {
					console.log("error");
					console.log(response);
				}
			}); // get budget
		}

		function calc_total_p(){
			var sum_percentages = document.getElementsByClassName('percent_cell');
			var sum = 0;
			for(j = 0; j < sum_percentages.length; j++){
				sum = sum + parseInt(sum_percentages[j].innerHTML);
			}
			tperc.innerHTML = parseInt(sum);

			if(tperc.innerHTML > 100){
				var snack = document.getElementById('snackbar-main');
				snack.className = 'show';
				snack.innerHTML = 'Please adjust your percentages to equal 100';
				setTimeout(function(){ snack.className = snack.className.replace("show", ""); }, 3000);
				tperc.style.backgroundColor = '#dd5252';
		   	}

		   	if (tperc.innerHTML < 100){
		   		var snack = document.getElementById('snackbar-main');
				snack.className = 'show';
				snack.innerHTML = 'Add more to your budget to reach 100%';
				setTimeout(function(){ snack.className = snack.className.replace("show", ""); }, 3000);
		   		tperc.style.backgroundColor = '#fffd89';
		   	}

		   	else{
		   		tperc.style.backgroundColor = 'white';
		   	}

		}

		function calc_total_d(){
			var tsal = document.getElementById('total_salary');
			var sum_d = document.getElementsByClassName('dollar_cell');
			var sum = 0;
			for(j = 0; j < sum_d.length; j++){
				sum = sum + parseFloat(sum_d[j].innerHTML.replace(/\$/g, ''));
			}
			tsal.innerHTML = '$'+parseFloat(sum).toFixed(2);

		}

		function new_user() {
			var new_us = document.getElementById('new_user_salary').value;
			var new_ul = document.getElementById('selectstate').value;

			if (new_us == '' | new_ul == 'Select your state' | isNaN(new_us)){
				var snack = document.getElementById('snackbar-new');
				snack.className = 'show';
				snack.innerHTML = 'Please enter in your yearly salary and current state';
				setTimeout(function(){ snack.className = snack.className.replace("show", ""); }, 3000);
			}

			else {
				yearly_salary = new_us;
				user_location = new_ul;
				console.log(yearly_salary);
				console.log(user_location);
	    		main.style.display = 'block';
	    		y.style.display = 'none';

				/* CreateBudget.php */
				$.ajax(url_base + "/CreateBudget.php",
		            {type: "POST",
		            dataType: "json",
		            data: JSON.stringify({
		                StateID: user_location,
		                Salary: yearly_salary
		            }),
		            success: function(budget) {
		                console.log(budget);
						user_name = budget['name'];
						user_location = user_location;
						yearly_salary = yearly_salary;
						after_tax_salary = budget['afterTaxSalary'];
		                // populate table
		                for(var i=0; i<budget.split.length; i++){
		                    var e = budget.split[i].name;
		                    var p = budget.split[i].percentage;
		                    enter_into_table(e,p);
		                }
						refresh_user_box();
		            },
		            error: function(response) {
		                console.log(response);
		            }
		        }); // create budget

	    		refresh_user_box();

			}
		}

		function refresh_user_box(){
					/*set all user name fields to the first name of user*/
			var user_divs = document.getElementsByClassName('user_name');
			var i;
			for (i = 0; i<user_divs.length; i++){
				user_divs[i].innerHTML = user_name;
			}

			var location_divs = document.getElementsByClassName('user_state');
			var h;
			for (h = 0; h<location_divs.length; h++){
				location_divs[h].innerHTML = user_location;
			}

			/*set user's yearly salary in all applicable locations*/
			var year_salary_divs = document.getElementsByClassName('user_salary');
			var j;
			for (j = 0; j<year_salary_divs.length; j++){
				year_salary_divs[j].innerHTML = '$' + yearly_salary;
			}

			/*set user's after tax salary(ats)*/
			var after_tax_salary_divs = document.getElementsByClassName('ats');
			var k;
			for (k = 0; k<after_tax_salary_divs.length; k++){
				after_tax_salary_divs[k].innerHTML = '$' + after_tax_salary;
			}
		}

		/*function edit_user_info(){
			var state = document.getElementsByClassName('user_state')[0];
			var edit_salary = document.getElementsByClassName('user_salary')[0];
			var edit_button = document.getElementById('edit_user_info');
			state.contentEditable = 'true';
			state.style.fontStyle = 'italic';
			edit_salary.contentEditable = 'true';
			edit_salary.style.fontStyle = 'italic';
			edit_button.style.display = 'none';
			save_user.style.display = 'block';
		}

		function save_user_info(){
			var state = document.getElementsByClassName('user_state')[0];
			var edit_salary = document.getElementsByClassName('user_salary')[0];
			var edit_button = document.getElementById('edit_user_info');
			state.contentEditable = 'false';
			state.style.fontStyle = 'normal';
			edit_salary.contentEditable = 'false';
			edit_salary.style.fontStyle = 'normal';
			edit_button.style.display = 'block';
			save_user.style.display = 'none';
		}*/

		function edit_table_func(){
			var expense_entries = document.getElementsByClassName('expense_cell');
			var percent_entries = document.getElementsByClassName('percent_cell');
			var dollar_entries = document.getElementsByClassName('dollar_cell');
			var tabs = document.getElementsByClassName('tablink');
			var k;
			for (k = 0; k < tabs.length; k++){
				tabs[k].disabled = true;
			}
			tmp = [];
			var i;
			for (i = 0; i < expense_entries.length; i++){
				expense_entries[i].contentEditable = 'true';
				percent_entries[i].contentEditable = 'true';
				expense_entries[i].style.fontStyle = 'italic';
				percent_entries[i].style.fontStyle = 'italic';
				tmp[i] = dollar_entries[i].innerHTML.replace(/\$/g, '');
				dollar_entries[i].innerHTML = '';

				var delete_button = document.createElement('button');
				delete_button.innerHTML = 'Delete';
				delete_button.className = 'delete_row';
				delete_button.onclick = function(){remove_row(this)};
				dollar_entries[i].append(delete_button);

			}
			document.getElementById('edit_table').style.display = 'none';
			document.getElementById('save_table').style.display = 'inline-block';

		}

		function save_table_func(){
			var expense_entries = document.getElementsByClassName('expense_cell');
			var percent_entries = document.getElementsByClassName('percent_cell');
			var dollar_entries = document.getElementsByClassName('dollar_cell');
			var tabs = document.getElementsByClassName('tablink');
			var k;
			for (k = 0; k < tabs.length; k++){
				tabs[k].disabled = false;
			}
			var i;
			for (i = 0; i < expense_entries.length; i++){
				expense_entries[i].contentEditable = 'false';
				percent_entries[i].contentEditable = 'false';
				expense_entries[i].style.fontStyle = 'normal';
				percent_entries[i].style.fontStyle = 'normal';

				dollar_entries[i].innerHTML = '$' + tmp[i];
			}

			document.getElementById('edit_table').style.display = 'inline-block';
			document.getElementById('save_table').style.display = 'none';

			calc_total_p();
			calc_total_d();

			/* ModifyBudget.php */
			modify_budget();
		}

		function modify_budget(){
			var expense_entries = document.getElementsByClassName('expense_cell');
			var percent_entries = document.getElementsByClassName('percent_cell');
			/* ModifyBudget.php */
			var obj  = {
	        	'salary' : yearly_salary,
	        	'state' : user_location,
	        	'afterTaxSalary' : after_tax_salary,
	        	'split' : [],
				'name' : user_name
			};

			console.log("length of table entries " + expense_entries.length);
	        for (var i = 0; i < expense_entries.length; i++){
	            console.log(expense_entries[i].innerHTML);
	            console.log(parseInt(percent_entries[i].innerHTML));
				obj.split.push({
					'name' : expense_entries[i].innerHTML,
					'percentage' : parseInt(percent_entries[i].innerHTML)
				});

	        }
	        console.log("object created " +JSON.stringify(obj));

	        $.ajax(url_base + "/ModifyBudget.php",
	            {type: "POST",
	            dataType: "json",
	            data: JSON.stringify(obj),
	            success: function(response) {
	                console.log("success - modify");
	                console.log(response);
	            },
	            error: function(response) {
	                console.log("error - modify");
	                console.log(response);
	            }
	        }); // modify budget
		}

		function enter_new_expense(){
			var e = document.getElementById('new_expense').value;
			var p = document.getElementById('new_percent').value;

			if(e == ''){
				var snack = document.getElementById('snackbar-main');
				snack.className = 'show';
				snack.innerHTML = 'Please enter an expense';
				setTimeout(function(){ snack.className = snack.className.replace("show", ""); }, 3000);
			}

			if(p == '' | isNaN(p)){
				var snack = document.getElementById('snackbar-main');
				snack.className = 'show';
				snack.innerHTML = 'Please enter a number as a percentage';
				setTimeout(function(){ snack.className = snack.className.replace("show", ""); }, 3000);
			}

			else{
				enter_into_table(e,p);
				modify_budget();

			}
			//save data to expense table for user
		}

		function logout_user(){
			save_table_func();
			/*save budget information, then redirect to login.html*/
			$.ajax(url_base + "/LogOut.php",
				{type: "POST",
				dataType: "json",
				success: function(response) {
					console.log("success - logout");
					console.log(response);
				},
				error: function(response) {
					console.log("error - logout");
					console.log(response);
				}
			});
			location.href = "Login.html";
		}

		function enter_into_table(e,p) {
			var new_row = document.createElement("tr");
			var row_cell_e = document.createElement("td");
			row_cell_e.innerHTML = e;
			row_cell_e.className = 'expense_cell';
			var row_cell_p = document.createElement("td");
			row_cell_p.innerHTML = parseInt(p, 10);
			row_cell_p.className = 'percent_cell';
			var row_cell_d = document.createElement("td");
			row_cell_d.innerHTML = '$'+(after_tax_salary*parseInt(p)/100).toFixed(2);
			row_cell_d.className = 'dollar_cell';
			var bottom_row = document.getElementById('add_row');
			new_row.append(row_cell_e);
			new_row.append(row_cell_p);
			new_row.append(row_cell_d);
			bottom_row.parentNode.insertBefore(new_row, bottom_row);

			document.getElementById('new_expense').value = "";
			document.getElementById('new_percent').value = "";

			calc_total_p();
			calc_total_d();
		}

		function remove_row(r){
			var i = r.parentNode.parentNode.rowIndex;
			document.getElementById('spending_table').deleteRow(i);
			tmp.splice((i-1),1);

			calc_total_p();

			var tsal = document.getElementById('total_salary');
			//var sum_d = document.getElementsByClassName('dollar_cell');
			var sum = 0;
			for(j = 0; j < tmp.length; j++){
				if(tmp[j] == null){
					sum = sum + 0;
				}
				else{
					sum = sum + parseFloat(tmp[j]);
				}
			}
			tsal.innerHTML = '$'+ sum.toFixed(2);
		}

		function openOption(optionName, elmnt, color) {
	    // Hide all elements with class="tabcontent" by default */
	    var i, tablinks, p_cells, d_cells;

	    d_cells = document.getElementsByClassName('dollar_cell');
	    p_cells = document.getElementsByClassName('percent_cell');

	    // Remove the background color of all tablinks/buttons
	    tablinks = document.getElementsByClassName("tablink");
	    for (i = 0; i < tablinks.length; i++) {
	        tablinks[i].style.backgroundColor = '';
	        tablinks[i].style.color = "";
	    }

	    // Show the specific tab content
	    if(optionName == 'Y'){
	    	for(i = 0; i < d_cells.length; i++){
	    		d_cells[i].innerHTML = '$'+(after_tax_salary*parseFloat(p_cells[i].innerHTML)/100).toFixed(2);
	    	}

	    	calc_total_d();

	    }
	    else if(optionName == 'M'){
	    	for(i = 0; i < d_cells.length; i++){
	    		d_cells[i].innerHTML = '$'+((after_tax_salary*parseFloat(p_cells[i].innerHTML)/100)/12).toFixed(2);
	    	}

	    	calc_total_d();

	    }
	    else{
	    	for(i = 0; i < d_cells.length; i++){
	    		d_cells[i].innerHTML = '$'+((after_tax_salary*parseFloat(p_cells[i].innerHTML)/100)/24).toFixed(2);
	    	}

	    	calc_total_d();
	    }

	    elmnt.style.backgroundColor = color;
	    elmnt.style.color = 'white';

		}

		// Get the element with id="defaultOpen" and click on it
		document.getElementById("defaultOpen").click();
	</script>
</body>
</html>
